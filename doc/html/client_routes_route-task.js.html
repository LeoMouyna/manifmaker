<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/routes/route-task.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/routes/route-task.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {ValidationService} from "../../both/service/ValidationService"
import {SecurityServiceClient} from "../../client/service/SecurityServiceClient"

/**
 * @memberOf Route
 * @namespace Route.Task
 */

/**
 * @memberOf Route.Task
 * @summary Display tasks list
 * @locus client
 * @name 'home'  /tasks
 */
Router.route('/tasks', function () {
        SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.TASKREAD);
        console.info("routing", "/tasks");

        this.render('tasksList', {
            to: 'mainContent'
        });
    },
    {name: 'task.list'}
)

/**
 * @memberOf Route.Task
 * @summary Display the create task form without time slots and validation workflow
 * @locus client
 * @name 'task.create'  /task
 */
Router.route('/task', function () {
        this.wait(Meteor.subscribe('users'));

        SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.TASKWRITE);
        console.info("routing", "/task");

        if (this.ready()) {
            this.render('insertTaskForm', {
                to: 'mainContent'
            });
        } else {
            console.log("Route /task : waiting team data"); //TODO add a spinner
        }

    },
    {name: 'task.create'}
);

/**
 * @memberOf Route.Task
 * @summary Display the task update form by it's MongoId
 * @locus client
 * @param taskId
 * @name 'task.read'  /task/:_id
 */
Router.route('/task/:_id', function () {
        this.wait(Meteor.subscribe('tasks'));
        this.wait(Meteor.subscribe('teams'));
        this.wait(Meteor.subscribe('places'));
        this.wait(Meteor.subscribe('skills'));
        this.wait(Meteor.subscribe('users'));
        this.wait(Meteor.subscribe('power-supplies'));

        if (this.ready()) {

            SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.TASKWRITE);
            console.info("routing", "/task/" + this.params._id);

            if(!Tasks.findOne(this.params._id)){
                console.info("routing", "task not found, rerouting to /tasks");
                Router.go("/tasks");
            }


            this.render('updateTaskForm', {
                data: function () {
                    var currentTask = this.params._id;
                    return Tasks.findOne({_id: currentTask});
                }, to: 'mainContent'
            });
        } else {
            console.log("waiting for data")
        }
    },
    {name: 'task.update'}
);


/**
 * @memberOf Route.Task
 * @summary Display the task in read mode by it's MongoId
 * @locus client
 * @param taskId
 * @name 'task.read'  /task/:_id
 */
Router.route('/task/:_id/read', function () {
        this.wait(Meteor.subscribe('tasks'));
        this.wait(Meteor.subscribe('teams'));
        this.wait(Meteor.subscribe('places'));
        this.wait(Meteor.subscribe('skills'));
        this.wait(Meteor.subscribe('users'));
        this.wait(Meteor.subscribe('power-supplies'));

        if (this.ready()) {

            SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.TASKREAD);
            console.info("routing", "/task/" + this.params._id);

            if(!Tasks.findOne(this.params._id)){
                console.info("routing", "task not found, rerouting to /tasks");
                Router.go("/tasks");
            }

            this.render('readTaskForm', {
                data: function () {
                    var currentTask = this.params._id;
                    return Tasks.findOne({_id: currentTask});
                }, to: 'mainContent'
            });

        } else {
            console.log("waiting for data")
        }
    },
    {name: 'task.read'}
);

/**
 * @memberOf Route.Task
 * @summary Update validation state for one the task part
 * @locus client
 * @param validationType
 * @param taskId
 * @param validationState
 * @name 'task.validation.timeSlot'  /task/validation/:validationType/:_id/:state
 */
Router.route('/task/validation/:validationType/:_id/:state', function () {
        if (this.params.state === "to-be-validated") {
            SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.TASKWRITE);
        } else {
            var validationType = this.params.validationType;
            if (validationType === "time-slot")
                SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.ASSIGNMENTVALIDATION, "time slot validation");
            if (validationType === "access-pass")
                SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.ACCESSPASSVALIDATION, "access pass validation");
            if (validationType === "equipment")
                SecurityServiceClient.grantAccessToPage(Meteor.userId(), RolesEnum.EQUIPMENTVALIDATION, "equipment validation");
        }
        console.info("routing", "/task/validation/" + this.params.validationType + "/" + this.params._id + "/" + this.params.state);

        var comment = $("#" + this.params.validationType + "-validation-new-comment").val();
        $("#" + this.params.validationType + "-validation-new-comment").val("");

        ValidationService.updateValidation(this.params._id, ValidationStateUrl[this.params.state], ValidationTypeUrl[this.params.validationType], comment);

        this.redirect("/task/" + this.params._id);

    },
    {name: 'task.validation.timeSlot'}
);










</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_.html"></a></li><li><a href="AssignmentServiceClient.html">AssignmentServiceClient</a></li><li><a href="InjectDataServerService.html">InjectDataServerService</a></li><li><a href="Leaf.html">Leaf</a></li><li><a href="SecurityServiceClient.html">SecurityServiceClient</a></li><li><a href="SecurityServiceServer.html">SecurityServiceServer</a></li><li><a href="ServerAssignmentService.html">ServerAssignmentService</a></li><li><a href="ServerReferenceCollectionsService.html">ServerReferenceCollectionsService</a></li><li><a href="ServerTaskService.html">ServerTaskService</a></li><li><a href="ServerUserService.html">ServerUserService</a></li></ul><h3>Namespaces</h3><ul><li><a href="Collection.html">Collection</a></li><li><a href="EasySearch.html">EasySearch</a></li><li><a href="Enum.html">Enum</a></li><li><a href="Meteor%2520Methods.html">Meteor Methods</a></li><li><a href="Meteor_Publish.html">Meteor_Publish</a></li><li><a href="Route.html">Route</a></li><li><a href="Route.Assignment.html">Assignment</a></li><li><a href="Route.Assignment.taskToUser.html">taskToUser</a></li><li><a href="Route.Assignment.userToTask.html">userToTask</a></li><li><a href="Route.collectionReference.html">collectionReference</a></li><li><a href="Route.common.html">common</a></li><li><a href="Route.Task.html">Task</a></li><li><a href="Route.User.html">User</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jun 20 2016 16:36:23 GMT+0200 (Paris, Madrid (heure d’été))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
