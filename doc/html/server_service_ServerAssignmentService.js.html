<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server/service/ServerAssignmentService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server/service/ServerAssignmentService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {TimeSlotService} from "../../both/service/TimeSlotService"
import {SecurityServiceServer} from "../../server/service/SecurityServiceServer"

/** @class ServerAssignmentService */
export class ServerAssignmentService {

    /**
     * @memberOf ServerAssignmentService
     * @summary Assignments.after.insert hook. Add TaskAssignment to Task and UserAssignment to User.
     * @locus server
     * @param assignmentId {MongoId}
     * @param assignment {Assignment}
     * @param fieldNames {Array&lt;String>}
     */
    static propagateAssignment(assignmentId, assignment, fieldNames) {
        console.log("propagateAssignment for", assignment);
        var assignment = assignment;
        var user = Users.findOne(assignment.userId),
            task = Tasks.findOne(assignment.taskId);

        var timeSlot = TimeSlotService.getTimeSlot(task, assignment.timeSlotId);

        var userAssignment = {
            taskName: task.name,
            start: timeSlot.start,
            end: timeSlot.end,
            assignmentId: assignment._id
        };
        Users.update(assignment.userId, {
            $push: {assignments: userAssignment}
        });

        var taskAssignment = {
            userName: user.name,
            start: timeSlot.start,
            end: timeSlot.end,
            assignmentId: assignment._id
        };
        Tasks.update(assignment.taskId, {
            $push: {assignments: taskAssignment}
        });
    }


    /**
     * @memberOf ServerAssignmentService
     * @summary Assignments.after.remove hook. Remove TaskAssignment to Task and UserAssignment to User.
     * @locus server
     * @param assignmentId {MongoId}
     * @param assignment {Assignment}
     */
    static removeAssignment(assignmentId, assignment) {
        console.log("removeAssignment for", assignment);
        var assignment = assignment;
        var updateUser = {},
            updateTask = {},
            user = Users.findOne(assignment.userId),//Meteor.users.findOne(review.userId),
            task = Tasks.findOne(assignment.taskId);

        //TODO use $pull
        updateUser.assignments = user.assignments;
        updateUser.assignments.pop(
            user.assignments.indexOf(
                _.findWhere(
                    user.assignments, {assignmentId: assignment._id}
                )
            )
        );
        Users.update(assignment.userId, {$set: updateUser});

        updateTask.assignments = task.assignments;
        updateTask.assignments.pop(
            task.assignments.indexOf(
                _.findWhere(
                    task.assignments, {assignmentId: assignment._id}
                )
            )
        );
        Tasks.update(assignment.taskId, {$set: updateTask});
    }

    /**
     * @summary Assignments.before.update
     * @description
     * - Collection Hooks :  Assignments.before.update
     * - Assignment can not be updated
     */
    static preventUpdate() {
        throw new Meteor.Error(400, "An 'Assignment' can't be update but only created or deleted");
    }

    /**
     * @summary Assignments.before.insert
     * @description
     * - Collection Hooks :  Assignments.before.insert
     * - Needed role : ASSIGNMENTTASKUSER
     */
    static allowInsert(userId, doc) {
        SecurityServiceServer.grantAccessToItem(userId, RolesEnum.ASSIGNMENTTASKUSER, doc, 'assignment');
    }

    /**
     * @summary Assignments.before.update
     * @description
     * - Collection Hooks :  Assignments.before.update
     * - Needed role : ASSIGNMENTTASKUSER
     */
    static allowUpdate(userId, doc, fieldNames, modifier, options) {
        SecurityServiceServer.grantAccessToItem(userId, RolesEnum.ASSIGNMENTTASKUSER, doc, 'assignment');
    }

    /**
     * @summary Assignments.before.remove
     * @description
     * - Collection Hooks :  Assignments.before.remove
     * - Needed role : ASSIGNMENTTASKUSER
     */
    static allowDelete(userId, doc) {
        SecurityServiceServer.grantAccessToItem(userId, RolesEnum.ASSIGNMENTTASKUSER, doc, 'assignment');
    }
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_.html"></a></li><li><a href="AssignmentServiceClient.html">AssignmentServiceClient</a></li><li><a href="InjectDataServerService.html">InjectDataServerService</a></li><li><a href="Leaf.html">Leaf</a></li><li><a href="SecurityServiceClient.html">SecurityServiceClient</a></li><li><a href="SecurityServiceServer.html">SecurityServiceServer</a></li><li><a href="ServerAssignmentService.html">ServerAssignmentService</a></li><li><a href="ServerReferenceCollectionsService.html">ServerReferenceCollectionsService</a></li><li><a href="ServerTaskService.html">ServerTaskService</a></li><li><a href="ServerUserService.html">ServerUserService</a></li></ul><h3>Namespaces</h3><ul><li><a href="Collection.html">Collection</a></li><li><a href="EasySearch.html">EasySearch</a></li><li><a href="Enum.html">Enum</a></li><li><a href="Meteor%2520Methods.html">Meteor Methods</a></li><li><a href="Meteor_Publish.html">Meteor_Publish</a></li><li><a href="Route.html">Route</a></li><li><a href="Route.Assignment.html">Assignment</a></li><li><a href="Route.Assignment.taskToUser.html">taskToUser</a></li><li><a href="Route.Assignment.userToTask.html">userToTask</a></li><li><a href="Route.collectionReference.html">collectionReference</a></li><li><a href="Route.common.html">common</a></li><li><a href="Route.Task.html">Task</a></li><li><a href="Route.User.html">User</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jun 20 2016 16:36:23 GMT+0200 (Paris, Madrid (heure d’été))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
